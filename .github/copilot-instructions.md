# majsoul-replay-editor 的 Copilot 使用说明

本文件面向仓库贡献者与自动化助手（如 Copilot）。目标是：**在不破坏既有脚本兼容性的前提下**，安全、一致、可复现地修改代码/文档/示例牌谱。

---

## 0. 项目定位（一句话）

这是一个用于 **Majsoul（雀魂）网页端** 的“回放注入/自制牌谱”脚本仓库：把 `main.js` 注入浏览器控制台后，再注入某个牌谱脚本，即可在网页端播放自定义回放。

支持站点：

- 中文服：https://www.maj-soul.com
- 日服：https://mahjongsoul.com
- 美服：https://mahjongsoul.yo-star.com

---

## 1. 安全与免责声明（务必遵守）

- 本项目属于**第三方脚本**，存在封号风险。
- **必须使用小号/测试号**进行验证与调试。
- 禁止在仓库中提交任何密钥、Cookie、Token、账号信息。

许可证：Apache-2.0（见 `LICENSE`）。

---

## 2. 仓库结构与“能改/慎改/不要改”边界

### 2.1 核心入口（高频改动区）

- `src/main.ts`：核心逻辑（TypeScript）。**优先修改这里**。
- `main.js`：用于控制台注入的产物（由 Rollup 从 `src/main.ts` 打包生成）。
- `add_function.js`：扩展能力/自制模式入口（历史包袱较重，容易引入兼容问题）。

### 2.2 文档与示例（推荐贡献区）

- `doc/`：中文权威文档。
- `doc/en/`：英文文档（文件命名与中文不完全一一对应，见第 6 节同步规则）。
- `examples/`：小而精的示例脚本（可用作最小复现）。
- `products/`：大量成品/分类牌谱与批处理脚本。

### 2.3 参考/工具区（谨慎）

- `using_MJSP/`：与 MajsoulPlus 相关的说明与资源。
- `products/*.py`、`products/*.js`（批处理/转换脚本）：改动前先确认用途，尽量小改。

### 2.4 不建议编辑（只读参考）

- `code.js`：体积巨大、用于参考的反混淆客户端代码（**不要改**；也尽量避免打开导致卡顿）。

---

## 3. 最常见工作流：浏览器控制台注入（手动测试）

> 本仓库没有统一的自动运行时测试；**验证以人工注入为准**。

1. 使用小号登录雀魂网页端。
2. F12 打开 DevTools → Console。
3. 复制粘贴 `main.js` 全部内容并执行。
4. 再复制粘贴一个牌谱脚本（`examples/` 或 `products/` 下任意 `.js`）并执行。
5. 网页里打开任意回放，观察是否能进入并按脚本播出。

粘贴被拦截时：先在控制台输入 `allow pasting`（中文环境可能需要 `允许粘贴`）。

排障建议：

- 页面卡死：刷新页面清状态后重试。
- 控制台报错：优先确认脚本是否重复注入、是否调用了不存在的函数、是否打破了 `main.js` 的公共接口。

---

## 4. TypeScript → main.js 的构建约定（必须一致）

本项目使用 Rollup 打包：

- 入口：`src/main.ts`
- 输出：项目根目录的 `main.js`
- 格式：`iife`（适合控制台直接执行）
- 构建脚本：见 `package.json`
  - `npm run build`：打包生成 `main.js`
  - `npm run watch` / `npm run dev` / `npm run prod`：调试/监听（按需）

修改 `src/` 下 TypeScript 后：

- **必须重新构建并更新 `main.js`**，保证仓库内 `main.js` 与源 `src/main.ts` 一致。

---

## 5. 贡献约定（避免破坏兼容）

### 5.1 API 稳定性

- 尽量保持 `main.js` 对外可用的“回放脚本调用方式”不变。
- 若必须改动公共行为：
  - 优先“新增可选参数/新函数”，避免破坏旧脚本。
  - 为新行为补充注释（TSDoc/JSDoc）。
  - 同步更新文档（见第 6 节）。

### 5.2 products / examples 的新增规则

- **优先通过新增文件实现新效果**，不要动已有经典牌谱文件的行为。
- 目录选择：
  - 立直相关：`products/3P/`、`products/4P/` 或其子目录。
  - 活动场特殊规则：`products/其他活动场特殊规则/`。
  - 自制模式：`products/自制模式/`。
  - 国标：`products/国标麻将/`。
- 命名建议：用“可读的中文描述 + 明确主题”，避免 `test.js` 这类无语义文件名。
- 示例脚本建议：
  - 顶部调用 `clearProject()`（如果该函数在当前版本存在）避免数据叠加。
  - 尽量做到“复制到控制台即可复现”。

### 5.3 add_function.js 的改动策略

- 这是高风险文件（历史逻辑多、耦合大）。
- 原则：能在 `products/` 通过脚本实现的功能，不要强行做成全局扩展。
- 若需要新增模式：优先在 `products/自制模式/` 先落地脚本，再考虑是否抽象进 `add_function.js`。

---

## 6. 文档与翻译同步规则（doc / doc/en）

### 6.1 中文文档（doc/）是权威

- 任何行为变更/新增函数/参数语义变更：必须先更新 `doc/`。

### 6.2 英文文档（doc/en/）需要同步（如果覆盖到对应主题）

当前英文文档文件名与中文不完全一致，大致对应：

- `doc/1_编辑游戏信息.md` → `doc/en/1_GameInfo.md`
- `doc/2_编辑每个小局.md` → `doc/en/2_RoundInfo.md`
- `doc/3_对局操作相关函数.md` → `doc/en/3_OperationFunc.md`
- `doc/4_对局操作相关函数（活动场）.md` → `doc/en/4_EventOperationFunc.md`
- `doc/5_部分进阶功能.md` → `doc/en/5_AdvancedFeatures.md`
- `doc/6_推荐使用变量函数汇总.md` → `doc/en/6_VariablesAndHelpers.md`

同步原则：

- 你改了中文对应章节，就尽量同步英文对应章节。
- 若本次修改难以完成英文同步：在 PR 描述中明确“未同步原因 + 需要补翻译的段落位置”。

---

## 7. 编写牌谱脚本常用对象/变量/函数索引（速查）

> 详细语义以 `doc/3_对局操作相关函数.md` 与 `doc/6_推荐使用变量函数汇总.md` 为准。

常见变量（回放脚本经常会读/写）：

- `player_datas`
- `begin_tiles`
- `player_tiles`
- `all_data`

常见流程函数（按回合推进常用）：

- `setRound`, `roundBegin`
- `setPaishan`, `randomPaishan`
- `setDealTiles`, `setDiscardTiles`
- `mopai`, `qiepai`
- `mingpai`, `zimingpai`
- `hupai`, `huangpai`, `liuju`
- `demoGame`（示例/演示）

活动场相关：参考 `doc/4_对局操作相关函数（活动场）.md`。

---

## 8. 质量门禁（每次改动至少做到这些）

### 8.1 改 JS 回放脚本（examples/products）

- 人工注入验证：至少跑通一次，确保控制台无明显报错。
- 确保脚本可独立运行（不依赖你本地的临时变量/特殊环境）。

### 8.2 改 TypeScript（src/）

- 本地构建一次，更新 `main.js`。
- 在 IDE 里确保 TypeScript 诊断无新增致命错误（能修就修；若是历史包袱，避免扩大影响面）。
- 注入验证：用新生成的 `main.js` 做一次手动注入回归。

---

## 9. PR / 提交建议（让维护更容易）

- 小步提交：一个 PR 只做一件事（新增一个模式 / 修一个 bug / 补一个文档章节）。
- PR 描述至少包含：
  - 变更目的（做了什么）
  - 影响面（改了哪些入口/是否影响旧脚本）
  - 如何验证（你用哪个脚本注入验证）
- 若新增目录或复杂模式：建议在对应目录补一个短 `README.md`，说明玩法与复现步骤。

---

如需我在本文件中补充某个“模式/函数/目录”的更细约定，直接提需求即可。
