# 编辑每个小局 (round)

## 起手

`begin_tiles` 表示对局玩家的起手, 字符串数组, 有效长度为不超过4, 下标 `i` 表示 `seat` 为 `i` 的玩家

注意亲家起手是14张, 闲家是13张

例子:

```js
begin_tiles[0] = '11122233344477z';
begin_tiles[1] = '1112340678999m';
begin_tiles[2] = '1112340678999p';
begin_tiles[3] = '1112340678999s';
```

如果为三人麻将, 则不要给 `begin_tiles[3]` 赋值, 保持其为空(二人麻将同理)

若玩家的起手牌数量不够, 则在调用下面的 `randomPaishan` 函数后会自动随机补全起手, 此时控制台会有提醒

但若起手牌数量偏多, 调用 `randomPaishan` 后控制台会有警告

注意: 参与对局的玩家的起手都不能为空, 主视角的起手牌数量不能多过多, 否则刚进牌谱就会崩溃

## 牌山

雀魂牌山的格式根据时间划分为两个阶段, 早期牌山(23年5月以前)不包含起手, 加密方式为 md5, 如今牌山包含起手, 加密方式为
sha256 (加盐)

为了缩减代码量, 仓库中的 md5 或 sha256 码都是虚假的, 不是真实计算的结果

### 直接设定

例子:

```js
setPaishan('3s4m1p7p7m8m1m3p1s1s5s9s8p9s2p7m2m8m4p3m6p4m3p1s1p5m2p2m5s7m0s3m4m6m8m6p0m4p7p1p8p3p1s1p2m3m7s3p7s9m2p8p4p6m9p6m9p7p7s8p6p4p6z9s9s7p9p6p7s5s2p5z6s3z4s2z0p7z8s1z2s4z5m');
```

参数字符串就是去掉起手之后的牌山

手动赋值牌山比较笨拙, 所以提供了下面的函数

### 随机牌山函数

`randomPaishan(ps_head, ps_back)`

`ps_head` 和 `ps_back` 分别指定去掉起手时牌山开头和结尾的部分

此外还支持该位置任意的剩下牌或者幺九牌用于占位,
用 `.` 表示任意剩下一张牌, `H` 表示一张字牌, `T` 表示一张老头牌, `Y` 表示一张幺九牌, `D` 表示一张中张牌,
`M`, `P`, `S` 分别表示一张万子, 饼子, 索子

如果剩下的牌中已经不存在满足条件的牌了, 则会从剩下的牌中随机选一张(即功能退化成 `.`)

另外, 起手可以根据上述规则随机化, 但前提是要调用该函数

为方便调试和阅读, `ps_head` 和 `ps_back` 的内部也可以加空格分隔, 空格不影响解读

例子:

```js
randomPaishan(); // 任意牌山
randomPaishan('3s'); // 以三索开头的牌山
randomPaishan('33s3s 3s', '1z'); // 以四个三索开头, 东风为第一张岭上牌的牌山, 可以简写, 中间的空格不影响
randomPaishan('', '1z....'); // 四麻以东风作为宝牌指示牌的牌山(三麻的话指示牌后面要跟8个点)
```

此外, `randomPaishan` 也会检查生成的牌山, 以及玩家的手牌是否合规(数量能不能对得上), 对不上会在控制台报警告,
又涉及到了三个变量:

- `chang`: 取值 0-3, 分别代表 东场, 南场, 西场, 北场
- `ju`: 取值 0-3, 分别代表四个玩家 `seat` 为多少的坐庄, 比如东二局 `ju` 的值就是1
- `ben`: 本场数

如: 西2局3本场 `chang`, `ju`, `ben` 三个变量的值分别是 2, 1, 3. 北1局1本场三个变量的值分别是 3, 0, 1.

`randomPaishan` 对于多出来的牌的处理, 相当于凭空混入了这些牌(而不是其他牌变成该牌),
这就导致相比于正常牌山, 多出来几张牌, 牌山总牌数就多几

### 两种方法的注意事项

由于官方逻辑限制, 牌山的总长度不能超过136, 所以:

- 使用 `randomPaishan` 方法时, 如果有不合规的警告, 则生成的牌山是不包含起手的, 如果没有, 则牌山包含起手
- 使用 `setPaishan` 方法时, 如果参数的牌数量加上玩家手牌超过了136, 或者玩家起手牌数量不合规, 则牌山不包含起手,
  反之则包含起手
- 若牌山在不含起手的情况下长度也超过了136, 超过的部分会直接截断, 以防止崩溃

起手部分的牌山也是随机化的, 即玩家起手的某张牌是在摸第几张时摸到的是随机的

## 每个玩家的切牌(可选)

`setDiscardTiles([qiepai0, qiepai1, qiepai2, qiepai3])`

`qiepai${i}` 表示 `seat` 为 `i` 的玩家在切牌 `qiepai()` 如果没有给定参数 `tile` 时切牌的顺序, 用字符串表示, 从左向右

`setDiscardTiles` 非常适合用来表示复杂的切牌情况

例子: `setDiscardTiles(['4z1z7z2m5m9s5s7p', '9m1s9s5z6z9p8s1p', '1m8s3s4m6z2z7z', '7p6s7s4s3s6m7m7p']);`

此外还有几点需要注意:

- `qiepai${i}` 中间还可以用 `.` 表示非具体的牌, 轮到这个牌时, 实际表现为"摸切", 即"摸切占位"
- 若 `qiepai${i}` 里面的切牌用完了, 则该参数对 `i` 号玩家的切牌不再有影响

## 每个玩家的摸牌(可选)

`setDealTiles([mopai0, mopai1, mopai2, mopai3])`

和 `setDealTiles` 很类似, `mopai${i}` 表示 `seat` 为 `i` 的玩家在摸牌 `mopai()` 如果没有给定参数 `tile` 时摸牌的顺序

例子: `setDealTiles(['4z1z7z2m5m9s5s7p', '9m1s9s5z6z9p8s1p', '1m8s3s4m6z2z7z', '7p6s7s4s3s6m7m7p']);`

此外还有几点需要注意:

- `mopai${i}` 中间还可以用 `.` 表示非具体的牌, 轮到这个牌时, 会摸牌山的牌
- 若 `mopai${i}` 里面的摸牌用完了, 则该参数对 `i` 号玩家的摸牌不再有影响
- 若在 `detail_rule` 中设置了 `_mopai_paishan`, 则 `randomPaishan` 会根据参数来生成牌山, 此时 `pshead`
  参数无效. 需要注意调用 `setDealTiles` 要在调用 `randomPaishan` 之前, 且该方法只适用于无人鸣牌的情况

## 对局的流程

每小局开始前, 要调用函数 `roundBegin();`

若在调用 `roundBegin` 前没有设置牌山, 则会调用无参数的 `randomPaishan`

开始编辑每一局的过程, 所用的函数在 [对局操作相关函数](3_对局操作相关函数.md)

活动场的话还可以参考 [对局操作相关函数(活动场)](4_对局操作相关函数（活动场）.md)
